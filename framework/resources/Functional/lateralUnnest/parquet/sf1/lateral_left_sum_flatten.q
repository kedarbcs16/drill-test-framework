select l.c_custkey, l.c_name, r.orderkey, sum(r.totalprice) sum_order from customer l inner join (select g.custkey custkey, g.name, g.orderkey, g.totalprice totalprice from (select row_number() over(partition by c_custkey) as rn, f.c_custkey custkey, f.c_name name, f.o.o_orderkey orderkey, f.o.o_totalprice totalprice from (select c_custkey, c_name, flatten(c_orders) as o from customer) f) g) r on (l.c_custkey = r.custkey) group by l.c_custkey, l.c_name, r.orderkey order by sum_order limit 50;
